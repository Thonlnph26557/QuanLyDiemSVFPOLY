@page "/monhoc/{hanhdong}/{idMonHoc?}"
@layout QLDSVLayout

@using QLDSVFPOLY.Blazor.Repository.Interfaces
@using QLDSVFPOLY.BUS.ViewModels.MonHoc
@using QLDSVFPOLY.BUS.ViewModels.ChuyenNganh
@using QLDSVFPOLY.BUS.ViewModels.ChuyenNganhMonHoc
@using QLDSVFPOLY.BUS.ViewModels.DiemSo
@using QLDSVFPOLY.Blazor.Components
@using System.Text
@using System.Text.Json

@inject IMonHocRepo _repoMonHoc
@inject IChuyenNganhRepo _repoChuyenNganh
@inject IChuyenNganhMonHocRepos _repoChuyenNganhMonHoc
@inject IMonHocRepo _repoMonHoc
@inject IDiemSoRepos _repoDiemSo
@inject IJSRuntime JS

@if (ListChuyenNganhVMActive == null)
{
    <LoadingIndicator></LoadingIndicator>
}
else
{
    <MudForm class="m-4">
        <div style="float:left" class="w-25">
            @if(imgUrl != null) {
                <MudImage Src="@imgUrl" Elevation="25" Class="rounded-lg w-100" Style="background-color: black;" />
            }
            else {
                <LoadingIndicator></LoadingIndicator>
            }
            
            <InputFile OnChange="@OnInputFileChanged"></InputFile>

        </div>

        <div style="float:left" class="w-75">
            <div class="row pl-5">
                <div class="col">
                    <MudTextField Label="Mã" Variant="Variant.Outlined" T="string" @bind-Value="@MaInput" />

                    <MudTextField Label="Tên" Variant="Variant.Outlined" T="string" Class="py-1" @bind-Value="@TenInput" />

                    <MudSelect T="int" Label="Trạng thái" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Class="py-1" @bind-Value="@TrangThaiInput">
                        <MudSelectItem T="int" Value="1">Hoạt động</MudSelectItem>
                        <MudSelectItem T="int" Value="0">Không hoạt động</MudSelectItem>
                    </MudSelect>

                    <MudSelect T="string" @bind-SelectedValues="ListStringMaChuyenNganh" MultiSelection="true" Label="Chuyên ngành" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Class="py-1">
                        @foreach (var item in ListChuyenNganhVMActive.Where(c => c.IdChuyenNganh.HasValue == false))
                        {
                            <MudSelectItem T="string" Value="@item.Ma">@item.TenChuyenNganh</MudSelectItem>
                        }
                    </MudSelect>

                    <div style="float:right;" class="pt-1">
                        <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Add" Color="Color.Primary" hidden="@(hanhdong != "chinhsua" ? true : false)">Lưu</MudButton>
                        <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Add" Color="Color.Primary" hidden="@(hanhdong != "them" ? true : false)" OnClick="ThemMonHoc">Thêm</MudButton>
                    </div>

                </div>
            </div>
        </div>
    </MudForm>
    <div style="clear:both;"></div>
    @if (idMonHoc != null)
    {
        <div class="m-4">
            <div class="row mt-3">
                <div class="col">
                    <MudTextField T="string" Label="Tên đầu điểm" Variant="Variant.Outlined"></MudTextField>
                </div>
                <div class="col">
                    <MudNumericField Label="Trọng số" Variant="Variant.Outlined" Step="10" Min="0" Max="100" @bind-Value="@TrongSoInput" />
                </div>
                <div class="d-flex justify-center align-center" FullWidth="true" style="width: 16%">
                    <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Add" Color="Color.Primary" @onclick="@ThemDauDiem">Thêm đầu điểm</MudButton>
                </div>
            </div>

            <MudTable Items="@listDiemSo">
                <HeaderContent>
                    <MudTh>STT</MudTh>
                    <MudTh>Tên đầu điểm</MudTh>
                    <MudTh>Trọng số</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@(stt++)</MudTd>
                        <MudTd>@context.TenDauDiem</MudTd>
                        <MudTd>@context.TrongSo</MudTd>
                    </RowTemplate>
                </MudTable>
            </div>

    }

}


@code {
    [Parameter]
    public string hanhdong { get; set; }
    [Parameter]
    public string? idMonHoc { get; set; }



    IList<IBrowserFile> _imgList = new List<IBrowserFile>();

    private List<ChuyenNganhVM> ListChuyenNganhVMActive;
    private List<ChuyenNganhMonHocVM> ListCNMHVM;
    private List<MonHocVM> ListMonHoc;
    private List<DiemSoVM> listDiemSo;

    private string? MaInput;
    private string? TenInput;
    private double TrongSoInput;
    private int TrangThaiInput;
    private IEnumerable<string> ListStringMaChuyenNganh = new HashSet<string>();

    private int stt = 1;
    IJSObjectReference module;
    record ImageDimensions(int Width, int Height);
    //load chậm
    #region imgurl
    private string imgUrl = "data:image/png;base64,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";
    #endregion 
    private async Task OnInputFileChanged(InputFileChangeEventArgs e) 
    {
        var file = e.File;
        var streamRef = new DotNetStreamReference(file.OpenReadStream(file.Size));
        var json = await module.InvokeAsync<string>("getImageDimensions", streamRef);
        var dimensions = JsonSerializer.Deserialize<ImageDimensions>(json);
        if (dimensions.Width > 250)
        {
            file = await file.RequestImageFileAsync(file.ContentType, 250, int.MaxValue);
        }
        var buffers = new byte[file.Size];
        await file.OpenReadStream().ReadAsync(buffers);
        string imageType = file.ContentType;
        imgUrl = $"data:{imageType};base64,{Convert.ToBase64String(buffers)}";
    }


    protected override async Task OnInitializedAsync()
    {
        module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/fileSize.js");
        await LoadListsAsync();
    }

    private async Task LoadListsAsync()
    {
        ListChuyenNganhVMActive = await _repoChuyenNganh.GetAllActiveAsync(new ChuyenNganhSearchVM());
        ListCNMHVM = await _repoChuyenNganhMonHoc.GetAllAsync(new ChuyenNganhMonHocSearchVM());
        ListMonHoc = await _repoMonHoc.GetAllAsync(new MonHocSearchVM());
        listDiemSo = await _repoDiemSo.GetAllActiveAsync(new DiemSoSearchVM());
        if (idMonHoc != null)
        {
            listDiemSo = listDiemSo.Where(c => c.IdMonHoc == Guid.Parse(idMonHoc)).ToList();
        }

    }


    private async Task ThemMonHoc()
    {
        bool task1Result = await _repoMonHoc.CreateAsync(new MonHocCreateVM()
            {
                Ma = MaInput,
                Ten = TenInput,
                TrangThai = TrangThaiInput,
                DuongDanAnh = "NotAvailable"
            });
        //Thêm thành công ms tiến hành
        if (task1Result)
        {
            await LoadListsAsync();
            var lastResult = ListMonHoc.FirstOrDefault(c => c.Ma == MaInput);

            Guid idTask1 = lastResult.Id;

            var listIdChuyenNganh = ConvertMaToIdCN();

            foreach (var item in listIdChuyenNganh)
            {
                await _repoChuyenNganhMonHoc.CreateAsync(new ChuyenNganhMonHocCreateVM()
                    {
                        IdChuyenNganh = item,
                        IdMonHoc = Guid.Parse(idMonHoc),
                        TrangThai = 1
                    });
            }
        }
        await LoadListsAsync();
    }

    private void ThemDauDiem()
    {
        _repoDiemSo.CreateAsync(new DiemSoCreateVM()
            {
                IdMonHoc = Guid.Parse(idMonHoc),
                TenDauDiem = TenInput,
                TrongSo = TrongSoInput,
                TrangThai = 1
            });
    }

    private void HandleImg(IBrowserFile img) 
    {
        
    }

    private async Task LoadDataOnGUI()
    {

    }

    private async Task SuaMonHoc()
    {
        bool task1Result = await _repoMonHoc.UpdateAsync(Guid.Parse(idMonHoc), new MonHocUpdateVM()
            {
                Ma = MaInput,
                Ten = TenInput,
                TrangThai = TrangThaiInput,
                DuongDanAnh = "NotAvailable"
            });
        if (task1Result)
        {
            await LoadListsAsync();
            var lastResult = ListMonHoc.FirstOrDefault(c => c.Id == Guid.Parse(idMonHoc));

            var listIdChuyenNganh = ConvertMaToIdCN();

            foreach (var item in ListCNMHVM)
            {
                if (item.IdMonHoc == Guid.Parse(idMonHoc) && listIdChuyenNganh.Any(c => c == item.IdChuyenNganh) == true)
                {
                    await _repoChuyenNganhMonHoc.RemoveAsync(item.IdChuyenNganh, item.IdMonHoc);
                }

            }
            foreach (var item in listIdChuyenNganh)
            {
                await _repoChuyenNganhMonHoc.CreateAsync(new ChuyenNganhMonHocCreateVM()
                    {
                        IdChuyenNganh = item,
                        IdMonHoc = Guid.Parse(idMonHoc),
                        TrangThai = 1
                    });
            }
        }
        await LoadListsAsync();

    }

    private Guid GetIdByMa(string iMa)
    {
        LoadListsAsync();
        return ListMonHoc.FirstOrDefault(c => c.Ma == iMa).Id;
    }

    private List<Guid> ConvertMaToIdCN()
    {
        var listString = ListStringMaChuyenNganh.ToList();
        List<Guid> listIdChuyenNganh = new List<Guid>();
        foreach (var i in listString)
        {
            listIdChuyenNganh.Add(ListChuyenNganhVMActive.FirstOrDefault(c => c.Ma == i).Id);
        }
        return listIdChuyenNganh;
    }
}