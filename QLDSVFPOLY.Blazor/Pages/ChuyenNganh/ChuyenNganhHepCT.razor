@page "/chuyennganhhep/chitiet/{idChuyenNganh}/{idChuyenNganhHep}"
@using QLDSVFPOLY.BUS.ViewModels.ChuyenNganh
@using QLDSVFPOLY.Blazor.Components;
@using QLDSVFPOLY.Blazor.Repository.Interfaces
@inject IToastService toastService
@inject ISessionStorageService _SStorage
@inject IJSRuntime JS


<style>
	#dd {
		border: 2px black;
		width: 400px;
		height: 300px;
		margin-left: 50px;
	}
</style>

@if (updateVm == null)
{
	<LoadingIndicator></LoadingIndicator>
}
else
{
	<MudText Typo="Typo.h5">Danh sách chuyên ngành</MudText>
	<MudForm class="m-4">
		<div style="float:left" class="w-25">
			<MudSpacer></MudSpacer>
			<MudImage Src="@updateVm.Ma" Elevation="25" Class="rounded-lg w-100" Style="background-color: black;" Fluid="true" />
			<InputFile OnChange="@OnInputFileChanged"></InputFile>
		</div>

		<div style="float:left" class="w-75">
			<div class="row pl-5">
				<div class="col">
					<MudTextField Label="Mã" Variant="Variant.Outlined" T="string" @bind-Value="@updateVm.Ma" For="() => updateVm.Ma"/>

					<MudTextField Label="Tên" Variant="Variant.Outlined" T="string" Class="py-1" @bind-Value="@updateVm.TenChuyenNganh" For="() => updateVm.TenChuyenNganh"/>

					<MudSelect T="int" Label="Trạng thái" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter" Class="py-1" @bind-Value="@updateVm.TrangThai" For="() => updateVm.TrangThai">
						<MudSelectItem T="int" Value="1">Hoạt động</MudSelectItem>
						<MudSelectItem T="int" Value="2">Tạm dừng hoạt động</MudSelectItem>
					</MudSelect>
					<div style="float:right;" class="pt-1">
						<MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Add" Color="Color.Primary" OnClick="@(()=>ShowConfirmSua(Guid.Parse(idChuyenNganhHep),updateVm))">Lưu</MudButton>
					</div>

				</div>
			</div>
		</div>
	</MudForm>

	<Confirmation ConfirmationMessage="Bạn có muốn sửa chuyên ngành không?" ConfirmationTitle="Thông báo" @ref="_confirmSua" ConfirmationChanged="()=>UpdateCN(IdSua,confirmchuyenNganhSua)"></Confirmation>

}
@code {

	[Parameter]
	public string idChuyenNganh { set; get; }

	[Parameter]
	public string idChuyenNganhHep { set; get; }

	//Su dung cho Update
	private ChuyenNganhUpdateVM updateVm = new ChuyenNganhUpdateVM();

	//Inject Repo cua ChuyenNganh
	[Inject] private IChuyenNganhRepo chuyenNganhRepo { set; get; }

	//Khai bao ra listChuyenNganh
	private List<ChuyenNganhVM> listChuyenNganhs;

	private ChuyenNganhSearchVM searchVM = new ChuyenNganhSearchVM();


	protected override async Task OnInitializedAsync()
	{
		module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/fileSize.js");
		await LoadDataUpdate();

	}

	private async Task LoadData()
	{
		listChuyenNganhs = await chuyenNganhRepo.GetAllActiveAsync(searchVM);

		var chuyenNganhLon = await chuyenNganhRepo.GetByIdAsync(Guid.Parse(idChuyenNganh));
		Guid idDaoTaoCN = chuyenNganhLon.IdDaoTao;
		listChuyenNganhs = listChuyenNganhs.Where(c => c.IdDaoTao == idDaoTaoCN).ToList();
	}

	private async Task LoadDataUpdate()
	{
		var chuyenNganhHep = await chuyenNganhRepo.GetByIdAsync(Guid.Parse(idChuyenNganhHep));

		updateVm.Ma = chuyenNganhHep.Ma;
		updateVm.TenChuyenNganh = chuyenNganhHep.TenChuyenNganh;
		updateVm.TrangThai = chuyenNganhHep.TrangThai;
		updateVm.IdChuyenNganh = Guid.Parse(idChuyenNganh);
		updateVm.DuongDanAnh = chuyenNganhHep.DuongDanAnh;
		updateVm.TrangThai = chuyenNganhHep.TrangThai;
	}

	private async Task UpdateCN(Guid idChuyenNganh, ChuyenNganhUpdateVM updateVm)
	{
		bool x = await chuyenNganhRepo.UpdateAsync(idChuyenNganh, updateVm);
		if (x)
		{
			toastService.ShowSuccess($"Sửa thành công");
			await LoadData();
		}
		else
		{
			toastService.ShowError($"Sửa thất bại");
		}

	}

	private async Task Clear()
	{
		updateVm.Ma = "";
		updateVm.TenChuyenNganh = "";
		updateVm.TrangThai = 0;
	}


	protected Confirmation _confirmSua { set; get; }

	private Guid IdSua { set; get; }
	private ChuyenNganhUpdateVM confirmchuyenNganhSua = new ChuyenNganhUpdateVM();

	private async Task ShowConfirmSua(Guid suaId, ChuyenNganhUpdateVM chuyenNganh)
	{
		IdSua = suaId;
		confirmchuyenNganhSua = chuyenNganh;
		_confirmSua.show();
	}

	DefaultImages defImg = new DefaultImages();
	IJSObjectReference module;
	record ImageDimensions(int Width, int Height);
	private async Task OnInputFileChanged(InputFileChangeEventArgs e)
	{
		var file = e.File;
		var streamRef = new DotNetStreamReference(file.OpenReadStream(file.Size));
		var json = await module.InvokeAsync<string>("getImageDimensions", streamRef);
		var dimensions = JsonSerializer.Deserialize<ImageDimensions>(json);
		if (dimensions.Width > 250)
		{
			file = await file.RequestImageFileAsync(file.ContentType, 250, int.MaxValue);
		}
		var buffers = new byte[file.Size];
		await file.OpenReadStream().ReadAsync(buffers);
		string imageType = file.ContentType;
		updateVm.Ma = $"data:{imageType};base64,{Convert.ToBase64String(buffers)}";
	}
}
